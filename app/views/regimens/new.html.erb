
<% %>
<script>
</script>
<style type="text/css">
 #popup {
 	top: 50px;
	height:80% ! important;
  }

  #reason_for_tb_treatment_change {
	height:80%;
	width:100%;
	background:none repeat scroll 0 0 light-grey;
	border-color: -moz-use-text-color -moz-use-text-color silver;
	border-style: none none solid;
	border-width: medium medium 1px;
	font-family: "Nimbus Sans L","Arial Narrow",sans-serif;
	font-size: 2.2em;
	padding-left: 5px;

  }

  #main_head{
	float: left;
	width: 100%;
	font-size: 23px;
	font-weight:bold;
  }

  #reason_for_change{
	height:379px;
	width:100%;
	background:none repeat scroll 0 0 light-grey;
	border-color: -moz-use-text-color -moz-use-text-color silver;
	border-style: none none solid;
	border-width: medium medium 1px;
	font-family: "Nimbus Sans L","Arial Narrow",sans-serif;
	font-size: 2.2em;
	padding-left: 5px;

  }

  #ok {
	float:right ! important;
	width: 150px;
  }

  #cancel {
	float:left ! important;
	width: 150px;
  }

  #cover {
	position: absolute;
	background-color: black;
	width: 100%;
	height: 100%;
	left: 0%;
	top: 0%;
	z-index: 500;
	opacity: 0.5;
	align: center;
	display:none;
  }

  #newText{
	top: 40%;
    	left: 40%;
	margin-top: -200px;
    	margin-left: -250px;
	position: absolute;
	margin-right:auto;
	width: 800px;
	height: 38px;
	padding-bottom: 10px;
	font-size: 2em;
	text-align: left;
	background-color: white;
	padding: 10px;
	z-index: 999;
	border: 5px outset tomato;
	border-radius: 15px;
	z-index: 900;
	display:none;
  }

  #alertPage{
	top: 50%;
    	left: 40%;
	margin-top: -200px;
 	margin-left: -250px;
	position: absolute;
	margin-right:auto;
	width: 800px;
	height: 400px;
	padding-bottom: 10px;
	font-size: 1em;
	text-align: center;
	background-color: white;
	padding: 10px;
	z-index: 999;
	border: 5px outset tomato;
	border-radius: 15px;
	z-index: 900;
  }

  #summary {
    	top: 60px;
	overflow:auto;
	height:450px ! important;
  }

  #contraindicators {
    	top: 50px;
	overflow:auto;
	height:80% ! important;
  }

  #tt_page_select_regimen #viewport {
    	height: 18em;
  }

  #tt_page_select_art_regimen .inputFrameClass {                                                            
    	height: 520px; 
  }

  #tt_page_select_art_regimen #viewport {
    	height: 470px; 
  }

  #tt_page_duration_of_art_drugs .options {  height: 90%; }

  #tt_page_duration_of_art_drugs .inputFrameClass {  height: 86%; }

  #tt_page_duration_of_prescribed_drugs .options {  height: 90%; }

  #tt_page_duration_of_prescribed_drugs .inputFrameClass {  height: 86%; }

  #previous_drugs_dispensed {
    	bottom: 380px;
    	font-size: 20px;
    	left: 25px;
    	position: absolute;
    	z-index: 600;
    	border-radius: 10px 10px 10px 10px;
    	width: 95%;
    	display: none;
  }  

  #previous_drugs_dispensed table th{
    	border-style: solid;
    	border-width: 1px;
    	background-color: lightgrey;
  }

  #previous_drugs_dispensed table {
    	width: 100%;
  }

  .tt_controls_duration_of_art_drugs .keyboard { display:none !important; }                    

  .unknownButton .numericKeyboard #char, #decimal, #slash, #star, #plus, #date, #minus, #comma, #percent {
	display: none;
  }

  .tt_controls_number_of_condoms_given #qwerty {
    	display: none;
  }

  .NoKeyboard .inputFrameClass {
	height:600;
  }

  .tt_controls_duration .abcKeyboard {
   	 display: none;
  }

  .tt_controls_select_art_regimen .abcKeyboard {
   	 display: none;
  }

  .tt_controls_select_art_regimen .qwertyKeyboard {
    	display: none;
  }

  .tt_controls_select_tb_regimen .qwertyKeyboard {
    	display: none;
  }

  .tt_controls_select_tb_regimen .abcKeyboard {
    	display: none;
  }

  .message{
	 top: 1%;
  	 left: 1%;
  }
  
  .adults{
	background:none repeat scroll 0 0 #87cefa;
	color:black;
	font-size: 12px;
  }

  .paeds{
	background:none repeat scroll 0 0 yellow;
	color:black;
	font-size: 12px;
  }
  .title{
	font-weight:bold;
	font-size:12px;
	padding: 5px;
  }
  .footer{
	font-weight:bold;
	font-size:12px;
	padding: 5px;
  }

  table {
	width:100%;
  }

  .tt_controls_duration_of_art_drugs .keyboard { display:none !important; }                    

  #tt_page_duration_of_art_drugs .options {  height: 90%; }                         

  #tt_page_duration_of_art_drugs .inputFrameClass {  height: 86%; }

  tr th {
	background-color:gray;
	padding:10px;
	font-size:12px;
  }

  td {
	text-align:left;
	text-transform: capitalize;
  }
 
  select {
    	border-bottom: 1px solid silver ! important;
	background-color: grey ! important;

  }

  option {
	background-color: white ! important;
	display:block;
	font-family: "Nimbus Sans L","Arial Narrow",sans-serif;
    	font-size: 1.2em;
    	list-style: none outside none;
    	margin-bottom: 5px;
    	margin-top: 5px;
    	padding-left: 5px;
    	padding-right: 5px;
  }

<<<<<<< HEAD
.NoKeyboard .inputFrameClass {
height:600;
}

.selectedOption {
    background-color: lightblue;
}

 table {
    -moz-user-select:none;
}

.prescription_container {
    border-style: solid;
    height: 350px;
    width: 96%;
    margin-left: 26px;
    overflow: auto;
}

.prescription_container table {
    -moz-user-select:none;
    width: 100%;
    font-size: 20px;
}

.prescription_container th {
    text-align: left;
    font-size: 25px;
    background-color: lightgrey;
}

.tr_blue {
    background-color: #E6E6FF;
}

.main {
background-color:gray;
padding:10px;
}
=======

  .NoKeyboard .inputFrameClass {
	height:600;

  .selectedOption {
    	background-color: lightblue;
  }

   table {
    	-moz-user-select:none;
  }

  .prescription_container {
    	border-style: solid;
    	height: 350px;
    	width: 96%;
    	margin-left: 26px;
    	overflow: auto;
  }

  .prescription_container table {
    	-moz-user-select:none;
    	width: 100%;
    	font-size: 20px;
  }

  .prescription_container th {
    	text-align: left;
    	font-size: 25px;
    	background-color: lightgrey;
  }

  .tr_blue {
    	background-color: #E6E6FF;
  }

  .main {
	background-color:gray;
	padding:10px;
  }
>>>>>>> bart2
</style>

<%= javascript_include_tag "prototype"%>

<script>
var patient_id = "<%= @patient.patient_id %>";
var tt_cancel_destination = "/patients/treatment_dashboard/<%= @patient.patient_id %>"
var current_regimens_for_programs = <%= @current_regimens_for_programs.to_json -%>;
var current_regimen_names_for_programs = <%= @current_regimen_names_for_programs.to_json -%>;
var reason_for_art = "<%= @reason_for_art_eligibility %>";
var prescribeTBDrugs = "<%= @prescribe_tb_drugs %>";
var prescribeARTDrugs = "<%= @prescribe_art_drugs %>";
var artVisit = "<%= @hiv_clinic_consultation %>";
var adverse_events = <%= @adverse_events.to_json %>
var regimen_index = '<%= @regimen_index %>';
var regimen_id = null;
var tb_regimen_id = null;
var reasons = ['Jandice/hepatitis','Anaemia < 8g/dl','History of psychiatric illness','Renal failure','Child under 12 years', 'Abacavir hypersensitivity', 'Other'] ;
var regimens = [];
var realTime = '<%=  @retrospective  %>';

function changeRegimen(){
<% unless @found_symptoms.blank? %>
element = document.getElementById('nextButton')
element.setAttribute("onmousedown", "contraindicators()")
<% else %>
  resetRegimen();
<%  end %>
}

function removeObs(td){
document.getElementById("reason_for_change").value = td.value
var reasons = document.getElementsByClassName('reasons')
  if (td.style.background != "#87cefa") {
  td.style.background = "#87cefa"
  
  } else{
  td.style.background = "#87cefa"
  //document.getElementById("reason_for_change").value = null
  }
  for (x= 0; x < reasons.length;  x ++){
  if (reasons[x] != td){
    reasons[x].style.background = "";
  }
  }
}

function updateForm(td){
  if (document.getElementById("reason_for_change").value != ""){
    document.getElementById('reason_antiretrovirals_changed_or_stopped').value = document.getElementById("reason_for_change").value;
    document.getElementById('cover').style.display='none';
    td.parentNode.style.display='none';
    gotoNextPage();
 }
}

function changeButton(){
  if (realTime == "false"){
       try {
        document.getElementById("reason_for_change").value = "";
      }
      catch (e){

      }
      element = document.getElementById('nextButton')
      element.setAttribute("onmousedown", "checkRegimen()")
    }
}

function resetRegimen(){
element = document.getElementById('nextButton')
element.setAttribute("onmousedown", "gotoNextPage()")
}

<<<<<<< HEAD
=======
  function resetRegimen(){
	element = document.getElementById('nextButton')
	element.setAttribute("onmousedown", "gotoNextPage()")
  }

>>>>>>> bart2
    function getArt(programId) {
    var aUrl = "/regimens/check_current_regimen_index?patient_age=<%= @patient_bean.age %>&id=" + programId + "&search_string=";
    var httpRequest = new XMLHttpRequest();
    httpRequest.onreadystatechange = function() {
      set_total(httpRequest);
    };
      httpRequest.open('GET', aUrl, false);
      httpRequest.send(null);
	  for (x=0; x < response.length; x ++){
		for (i =0; i < regimens.length; i ++){
		  if (response[x][0].split('-')[1].toString().downcase == regimens[i].toString().downcase){

			found = response[x][0].split('-')[0]
		  }
		}
	  }
  }

  function set_total(req) {
    if (req.readyState == 4 && req.status == 200) {
     response = JSON.parse(req.responseText);
    }
  }
<<<<<<< HEAD
=======

>>>>>>> bart2

  function contraindicators(){
				var foundEvents = []
				symptoms = '<%= @found_symptoms.join(',').humanize %>';
				symptoms = symptoms.split(',');
				selected = $('regimen_concept_id').options[$('regimen_concept_id').selectedIndex].text.split("-")[0][0];
				for (x=0; x < adverse_events[selected.toString()]["adverse"].length; x++){
				  for (i = 0; i < symptoms.length; i++){
					var re = new RegExp(symptoms[i].toString(), "i")
					if (adverse_events[selected.toString()]["adverse"][x][0].toString().match(re) != null){
					  foundEvents.push(symptoms[i]);
					}
				  }

				}
				for (x=0; x < adverse_events[selected.toString()]["contraindications"].length; x++){
				  for (i = 0; i < symptoms.length; i++){
					var re = new RegExp(symptoms[i].toString(), "i")
					if (adverse_events[selected.toString()]["contraindications"][x][0].toString().match(re) != null){
					  foundEvents.push(symptoms[i]);
					}
				  }

				}
				
				if ((foundEvents.length > 0) && (realTime == "false" )){
				var chart_color = " adults";
				
				<% if @patient_bean.age < 15%>
					chart_color = " paeds"
				<%  end %>
				var ele = document.getElementById('cover')
				ele.style.display = "inline";
				document.body.appendChild(ele);

				var newDiv = document.createElement('div');
				newDiv.id = "alertPage";
				newDiv.style.left = "32%";
				newDiv.style.top = "30%";
				newDiv.style.width = "850px";
				newDiv.style.height = "500px";

				var display = "<div><table><tr valign='top'><th></th><th class='title'>Regimen: </th>";
				 display += "<th class='title'>Contraindicators Noticed: </th>";
				 display += "<th class='title'>Possible adverse event: </th>";
				 display += "<th class='title'>Alternate Regimen 1: </th>";
				 display += "<th class='title'>Alternate Regimen 2: </th></tr>";
				/* display += "<tr><td class='title main'>Current <td><table>";
				<% (@regimen_formulations || []).each do |data| %>
					  regimens.push('<%=data[0].split(" ").first%>');
					  display += "<tr><td>" + "<%=data[0].split(" ").first%> " + "</td></tr>"
				<%end%>
				display += "</table></td><td><table>";
				for (x=0; x < adverse_events[regimen_index[0].toString()]["contraindications"].length; x++){
				   display += "<tr><td>" + adverse_events[regimen_index[0].toString()]["contraindications"][x][0] + "</td></tr>"
				}
				display += "</table></td><td><table>";
				for (x=0; x < adverse_events[regimen_index[0].toString()]["adverse"].length; x++){
				   display += "<tr><td>" + adverse_events[regimen_index[0].toString()]["adverse"][x][0] + "</td></tr>"
				}
				display += "</table></td><td><table>"
				for (x=0; x < adverse_events[regimen_index[0].toString()]["alt1"].length; x++){
				   display += "<tr><td>" + adverse_events[regimen_index[0].toString()]["alt1"][x][1] + "</td></tr>"
				}
				display += "</table></td><td><table>";
				for (x=0; x < adverse_events[regimen_index[0].toString()]["alt2"].length; x++){
				   display += "<tr><td>" + adverse_events[regimen_index[0].toString()]["alt2"][x][1] + "</td></tr>"
				}
				display += "</table></td></tr>"; //Alt 2 */
				//Selected Regimen
				
				display += "<tr><td colspan='6'><hr></td></tr><tr  class='" + chart_color +"'><td class='title" + chart_color +"'>Selected </td><td>" + $('regimen_concept_id').options[$('regimen_concept_id').selectedIndex].text + "</td><td><table>";
				for (x=0; x < adverse_events[selected.toString()]["contraindications"].length; x++){
				   display += "<tr><td>" + adverse_events[selected.toString()]["contraindications"][x][0] + "</td></tr>"
				}
				display += "</table></td><td><table>"
				for (x=0; x < adverse_events[selected.toString()]["adverse"].length; x++){
				   display += "<tr><td>" + adverse_events[selected.toString()]["adverse"][x][0] + "</td></tr>"
				}
				display += "</table></td><td><table>"
				for (x=0; x < adverse_events[selected.toString()]["alt1"].length; x++){
				   display += "<tr><td>" + adverse_events[selected.toString()]["alt1"][x][1] + "</td></tr>"
				}
				display += "</table></td><td><table>"
				for (x=0; x < adverse_events[selected.toString()]["alt2"].length; x++){
				   display += "<tr><td>" + adverse_events[selected.toString()]["alt2"][x][1] + "</td></tr>"
				}
				display += "</table></td></tr><tr><td colspan='6'><hr></td></tr><tr valign='top'><td colspan='2' class='footer'>Observed Symptoms:</td><td><table>";
				<% (@found_symptoms || []).each do |data| %>
					  display += "<tr><td style='font-size:12px;'>" + "<%=  data.humanize %>" + "</td></tr>"
				<%end%>
				display += "</table></td><td colspan='2' class='footer'>Matching with <br>Contraindicators and events</td><td><table>"
				
				for (x=0; x < foundEvents.length; x++){
				   display += "<tr><td style='font-size:12px;'>" + foundEvents[x] + "</td></tr>"
				}
				display += "</table></td></tr><tr><td colspan='6'><hr></td></tr></table></div>"; //Alt 2

				newDiv.innerHTML = '<div id="contraindicators">' + display + '</div>' ;
				document.body.appendChild(newDiv);

				var newBtn = document.createElement('button');
				newBtn.className = "navButton red";
				newBtn.id = "cancel";
				newBtn.innerHTML = "<span>Cancel</span>";
				newDiv.appendChild(newBtn);
				newBtn.setAttribute('onclick', "document.getElementById('cover').style.display='none'; this.parentNode.style.display='none';")

				var newBtn = document.createElement('button');
				newBtn.className = "green navButton";
				newBtn.id = "ok";
				newBtn.innerHTML = "<span>Next</span>";
				newDiv.appendChild(newBtn);
				newBtn.setAttribute('onclick', "document.getElementById('cover').style.display='none'; this.parentNode.style.display='none';gotoNextPage();")
			}
			else {
			  resetRegimen();
			  gotoNextPage();
			}
  }

  function setSelectedRow() {
	l = document.getElementsByTagName('li');
	for (i = 0 ; i < l.length ; i++) {
	  if (l[i].style.backgroundColor == 'lightblue')
		updateTouchscreenInputForSelect(l[i]);
	}
  }
 
  function checkRegimen(){
	
	if (document.getElementById('continue_existing_regimen').value == "NO"){
	var ele = document.getElementById('cover')
	ele.style.display = "inline";
	document.body.appendChild(ele);

	var newDiv = document.createElement('div');
	newDiv.id = "alertPage";
	newDiv.style.left = "32%";
	newDiv.style.top = "30%";
	newDiv.style.width = "840px";
	newDiv.style.height = "500px";

	var display = "<div id='main_head'><span>Reason for regimen change</span></div>";
	display += "<div height='800'><select id='reason_for_change' size='6'>";
	display += "<option value=''></option>"
	for (x=0; x < reasons.length; x++){
	  display += "<option value='" + reasons[x] + "' onmousedown='removeObs(this)' class='reasons'>" + reasons[x] + "</option>";
	}
	display += "</select></div>";
	newDiv.innerHTML = '<div id="popup">' + display + '</div>' ;
	document.body.appendChild(newDiv);

	var newBtn = document.createElement('button');
	newBtn.className = "navButton red";
	newBtn.id = "cancel";
	newBtn.innerHTML = "<span>Cancel</span>";
	newDiv.appendChild(newBtn);
	newBtn.setAttribute('onclick', "document.getElementById('cover').style.display='none'; this.parentNode.style.display='none';")

	var newBtn = document.createElement('button');
	newBtn.className = "green navButton";
	newBtn.id = "ok";
	newBtn.innerHTML = "<span>Next</span>";
	newDiv.appendChild(newBtn);
	newBtn.setAttribute('onclick', "updateForm(this);")
	
	}
	else {
	  resetRegimen();
	  gotoNextPage();
	}
  }

  function updateConcept(){

	var dates = new Date();
	var myForm = document.getElementById('regimen_form')
	var newOption = document.createElement("input");
		
	newOption.type = "hidden"
	newOption.name = 'observations[][concept_name]';
	newOption.value = 'Reason antiretrovirals changed or stopped';
	myForm.appendChild(newOption);

	var newOption = document.createElement("input");
	newOption.type = "hidden"
	newOption.name = "observations[][value_text]";
	newOption.value = document.getElementById('reason_for_art_treatment_change').value;
	myForm.appendChild(newOption);

	var newOption = document.createElement("input");
	newOption.type = "hidden"
	newOption.name = "observations[][patient_id]";
	newOption.value = '<%= @patient.id %>';
	myForm.appendChild(newOption);

	var newOption = document.createElement("input");
	newOption.type = "hidden"
	newOption.name = "observations[][obs_datetime]";
	newOption.value = dates;
	myForm.appendChild(newOption);
  }

  function checkTbRegimen(){
	var ele = document.getElementById('cover')
	ele.style.display = "inline";
	document.body.appendChild(ele);

	var newText = document.createElement('div');
	newText.id = "newText";
	newText.style.display = "inline";
	newText.innerHTML = "Reason TB treatment changed";
	document.body.appendChild(newText);

	var newDiv = document.createElement('div');
	newDiv.id = "alertPage";
	newDiv.className = "inputFrameClass";
	//newDiv.innerHTML = "<p>Help</p>";
	document.body.appendChild(newDiv);

	document.getElementById('reason_for_tb_treatment_change').setAttribute('multiple', 'multiple')

	var reason = document.getElementById('reason_for_tb_treatment_change');
	reason.style.display = "block";
	reason.className = "touchscreenTextInput";
	newDiv.appendChild(reason);

	var newBtn = document.createElement('button');
	newBtn.className = "navButton red";
	newBtn.id = "cancel";
	newBtn.innerHTML = "<span>Cancel</span>";
	newDiv.appendChild(newBtn);
	newBtn.setAttribute('onclick', "document.getElementById('newText').style.display='none';document.getElementById('cover').style.display='none'; this.parentNode.style.display='none';gotoPage(2, null, true);")

	var newBtn = document.createElement('button');
	newBtn.className = "green navButton";
	newBtn.id = "ok";
	newBtn.innerHTML = "<span>Next</span>";
	newDiv.appendChild(newBtn);
	newBtn.setAttribute('onclick', "document.getElementById('cover').style.display='none';document.getElementById('newText').style.display='none';this.parentNode.style.display='none';gotoNextPage();")

  }

  function set_patient_program_for_suggestions(programId) {
	//var program_id = encodeURIComponent($('patient_program').value);
	$('touchscreenInput'+tstCurrentPage).setAttribute('ajaxURL', "/regimens/suggested?patient_age=<%= @patient_bean.age %>&id=" + programId + "&search_string=");
	listSuggestions(tstCurrentPage);
	//$("regimen_concept_id").setAttribute("onmousedown", alert('yes'))
  }

  function set_regimen_concept_id_for_regimen(patientProgram, conceptId) {
	// It is really helpful to just set this
	if (selectedValue("continue_existing_regimen") == "YES") {
	  value = current_regimens_for_programs[patientProgram];
	  $('regimen_concept_id').innerHTML = "<option selected='selected'>" + value + "</option>";
	}

	if (selectedValue("tb_continue_existing_regimen") == "YES") {
	  value = current_regimens_for_programs[patientProgram];
	  $('tb_regimen_concept_id').innerHTML = "<option selected='selected'>" + value + "</option>";
	}
	//var concept_id = encodeURIComponent($('regimen_concept_id').value);
	$('touchscreenInput'+tstCurrentPage).setAttribute('ajaxURL', "/regimens/dosing?patient_id=<%= @patient.patient_id %>&id=" + conceptId + "&search_string=");
	listSuggestions(tstCurrentPage);
  }

  function set_regimen_concept_id_for_duration(regimenConceptId) {
	return false
	//var regimen_concept_id = encodeURIComponent($('regimen_concept_id').value);
	$('touchscreenInput'+tstCurrentPage).setAttribute('ajaxURL', "/regimens/durations?id=" + regimenConceptId + "&search_string=");
	listSuggestions(tstCurrentPage);
  }

  function buildPrescriptionPage(continueExistingRegimen, patientProgram, regimenConceptId, prescriptionContainer) {
	$('touchscreenInput'+tstCurrentPage).setAttribute('type','hidden');
	$('clearButton').style.display = 'none';
	$('keyboard').style.display = 'none';
	$('viewport').style.display = 'none';
	$('helpText'+tstCurrentPage).innerHTML = "Select doses. Current patient weight:&nbsp;<%=@current_weight%>";

	if(continueExistingRegimen == 'YES') {
	  var reg_id = current_regimens_for_programs[patientProgram];
	} else {
	  var reg_id = encodeURIComponent(regimenConceptId);
	}

	current_page = $('page'+tstCurrentPage);

	html = "&nbsp;<div id = '" + prescriptionContainer + "' class='prescription_container' ><table><tr>"
	html += "<th>Drug name</th><th>Dose</th><th>Units</th><th>Daily dose</th>"
	html += "</tr></table></div>"
	current_page.innerHTML += html

	new Ajax.Request("/regimens/formulations?patient_id=<%=@patient.id %>&id=" + reg_id ,{method:'get',onSuccess: function(transport){
		formulations = JSON.parse(transport.responseText) || "";
		if(formulations.length > 0 && formulations != "[[[]]]" && formulations != "[]"){
		  formulations = formulations[0]
		  prescription_container = $(prescriptionContainer);
		  html = "<table>"
		  html += "<tr><th>Drug name</th><th>Dose</th><th>Units</th><th>Daily dose</th></tr>"
		  for (i = 0 ; i < formulations.length ; i++) {
			data = formulations[i]
			regimen_id = data[4]
			html += "<tr><td>" + data[0] + "</td>"
			html += "<td>" + data[1] + "</td>"
			html += "<td>" + data[3] + "</td>"
			html += "<td>" + data[2] + "</td></tr>"
			$('touchscreenInput'+tstCurrentPage).value += data[0] + ':';
			$('touchscreenInput'+tstCurrentPage).value += " " + data[1] ;
			$('touchscreenInput'+tstCurrentPage).value += " " + data[3] ;
			$('touchscreenInput'+tstCurrentPage).value += " " + data[2] ;
		  }
		  html += "</table>"
		  prescription_container.innerHTML = html
		}
	  }});

  }

  function showTbDrugs() {
	var prescription_container = $("previous_drugs_dispensed");
	var html = "<table>"
	html += "<tr><th>Drug name</th><th>Dose</th><th>Units</th><th>Daily dose</th></tr>"
<% (@tb_regimen_formulations || []).each do |data| %>
	  regimen_id = <%= data[4]%>
	  html += "<tr><td>" + "<%=data[0]%>" + "</td>"
	  html += "<td style='text-align:center;'>" + "<%=data[1]%>" + "</td>"
	  html += "<td>" + "<%=data[3]%>" + "</td>"
	  html += "<td>" + "<%=data[2]%>" + "</td></tr>"
<%end%>
	html += "</table>"
	prescription_container.innerHTML = html
	prescription_container.style.display = "inline";
  }

  function setRegimenId(regimen) {
	if(regimen == 'ART') {
	  $('regimen').value = regimen_id
	} else if(regimen == 'TB'){
	  $('tb_regimen').value = regimen_id
	} else {
	  $('tb_continuation_regimen').value = regimen_id
	}
	$('clearButton').style.display = 'inline';
	$('keyboard').style.display = 'inline';
	$('viewport').style.display = 'inline';
  }

  function hasReasonForART() {
	if(reason_for_art.length == 0 || reason_for_art.match(/NONE/i)) {
	  return false;
	}

	return true;
  }

  function hasARTVisit() {
	returnValue = false;

	if (artVisit == "true") {
	  returnValue = true;
	} else {
	  returnValue = false;
	}

	return returnValue;
  }

  function prescribeAntiretroviralDrugs() {
	var prescribe = false;
	if(prescribeARTDrugs == 'true'){
	  prescribe = true;
	}
	return prescribe;
  }
  
  function isRegisteredForTB() {
	var isRegistered = false;
	if(prescribeTBDrugs == 'true'){
	  isRegistered = true;
	}
	return isRegistered;
  }
  
  function showResults(){
	var innerHtml = '';
	var resultString = '';

	<% if @patient_bean.sex == 'Female' && @patient_bean.age > 14 %>
	 	 resultString = '<b>Pregnancy Status:</b><%=" #{@is_patient_pregnant_value}"%><br><br>'
	<% end %>

	<% if @family_planning_methods.length != 0 %>
	  	resultString += '<b>Family Planning Methods:</b><br><ul>'
  		<%
  		family_planning_methods = @family_planning_methods.uniq.sort.map do |method|
			"<li> #{method}</li>"
  		end
	end
	%>

	resultString += <%= "'#{family_planning_methods}'" %>
	resultString += '</ul>'

	innerHtml = '<div id="summary"><div>' +
	  '<span class="title" style="font-size:25px;padding-top:7px;">' + resultString + '</span>' +
	  '</div></div>'
                     
	$('inputFrame'+tstCurrentPage).innerHTML = innerHtml
  }

  function showDrugs() {
	var prescription_container = $("previous_drugs_dispensed");
	var html = "<table>"
	html += "<tr><th>Drug name</th><th>Dose</th><th>Units</th><th>Daily dose</th></tr>"
	<% (@regimen_formulations || []).each do |data| %>
		regimen_id = <%= data[4]%>
		html += "<tr><td>" + "<%=data[0]%>" + "</td>"
		html += "<td style='text-align:center;'>" + "<%=data[1]%>" + "</td>"
		html += "<td>" + "<%=data[3]%>" + "</td>"
		html += "<td>" + "<%=data[2]%>" + "</td></tr>"
	<%end%>
	html += "</table>"
	prescription_container.innerHTML = html
	prescription_container.style.display = "inline";
  }

  function setAttributes() {
	$("backButton").setAttribute("onmousedown","gotoPage(" +(tstCurrentPage - 1) +", null, true);resetRegimen();");
	$("inputFrame"+tstCurrentPage).style.cssText = "height: 170px;";
	var nextButton = $("nextButton");
	nextButton.setAttribute("onmousedown","resetNextButton();gotoNextPage();")
  }

  function resetAttributes() {
	$("backButton").setAttribute("onmousedown","gotoPage(" + tstCurrentPage +", null, true)");
	$("previous_drugs_dispensed").style.cssText = "display: none;";
	set_regimen_concept_id_for_regimen($('patient_program').value, $('regimen_concept_id').value);
	setRegimenId('ART');
  }

  function resetNextButton() {
	$("previous_drugs_dispensed").style.cssText = "display: none;";
	$("nextButton").setAttribute("onmousedown","gotoNextPage();");
  }

  //function resetRegimen() {
  //}

  function hideKeyBoard() {
	$('page'+tstCurrentPage).getElementsByClassName("keyboard")[0].style.display='none';
  }

  function existingRegimen() {
	return hasReasonForART() == true &&
	  current_regimens_for_programs[$("patient_program").value] != null
	  && $("prescribe_arvs").value == "YES";
  }

  function continueRegimen() {
	var existingRegimen = "";
	if ($("continue_existing_regimen").value == "NO"){
	  existingRegimen = 'true'
	}else{
	  existingRegimen = 'false'
	}
	return existingRegimen;
  }
</script>
<body>
   <div id="cover" align="center">
  </div>
<form id='regimen_form' action="/regimens/create" method='post'>

  <%= hidden_field_tag :patient_id, @patient.id %>

  <!-- TB regimen -->
  <% if current_user.activities.include?('Manage Lab Orders') or current_user.activities.include?('Manage Lab Results') or
	  current_user.activities.include?('Manage Sputum Submissions') or current_user.activities.include?('Manage TB Clinic Visits') or
	  current_user.activities.include?('Manage TB Reception Visits') or current_user.activities.include?('Manage TB Registration Visits') or
	  current_user.activities.include?('Manage HIV Status Visits') %>

	<% if (@family_planning_methods.length != 0) || ( @patient_bean.sex == 'Female' && @patient_bean.age > 14 ) %>
	  <%= text_field_tag :task_name, nil,
		{   :tt_onLoad => "showResults();__$('keyboard').style.display = 'none'",
		:optional => "true",
		:tt_pageStyleClass => "NoControls",
		:helpText => '' } %>
	<% end %>
  <% end %>

  <% unless @transfer_out_patient %>

	<%= touch_yes_no_tag "Prescribe drugs", @patient, nil,
	  {	:optional => false,
	  :id => 'prescribe_tb_drugs',
	  :condition => 'isRegisteredForTB() == true',
	  :helpText => "Prescribe TB Regimen?" } %>

  <%end%>

  <% unless @tb_programs.uniq.count == 1 %>
	<%= select_tag :tb_patient_program, options_for_select(@tb_programs.map{|program| [program.program.name, program.patient_program_id] if PatientProgram.find(program.patient_program_id).date_completed == nil}),
	  {	:textCase => "upper",
	  :condition => '$("prescribe_tb_drugs").value == "YES"',
	  :allowFreeText => 'false',
	  :helpText => "Prescribe regimen for which TB program?" } %>
  <%else%>
	<%= hidden_field_tag(:tb_patient_program, @tb_programs.first.patient_program_id) %>
  <%end%>

  <% unless @transfer_out_patient %>

	<%= select_tag :tb_continue_existing_regimen, options_for_select([['',''],['Yes','YES'],['No','NO']], ''),
	  {	:textCase => "upper",
	  :allowFreeText => 'false',
	  :condition => 'current_regimens_for_programs[$("tb_patient_program").value] != null && $("prescribe_tb_drugs").value == "YES"',
	  :tt_onLoad => 'showTbDrugs();setAttributes();',
	  :tt_onUnLoad => 'resetAttributes();',
	  :helpText => "Continue current TB regimen?" } %>

	<%	initial_regimen_help_text = "Select TB regimen"
	if @transfer_out_patient
	  initial_regimen_help_text = "Select Inital TB regimen"
	end %>

	<%= select_tag :tb_regimen_concept_id, nil,
	  {	:ajaxUrl => "",
	  :allowFreeText => 'false',
	  :tt_onLoad => "set_patient_program_for_suggestions($('tb_patient_program').value);setTimeout('setSelectedRow()',500);",
	  :condition => '$("prescribe_tb_drugs").value == "YES" && $("tb_continue_existing_regimen").value != "YES"',
	  :helpText => "#{initial_regimen_help_text}" } %>

	<%= text_field_tag :tb_regimen, nil,
	  {
	  :ajaxUrl => "",
	  :tt_onUnLoad => "setRegimenId('TB');" ,
	  :allowFreeText => true ,
	  :tt_onLoad => "set_regimen_concept_id_for_regimen($('tb_patient_program').value, $('tb_regimen_concept_id').value);buildPrescriptionPage($('tb_continue_existing_regimen').value,  $('tb_patient_program').value, $('tb_regimen_concept_id').value, 'tb_prescription_container');",
	  :condition => '$("prescribe_tb_drugs").value == "YES"',
	  :helpText => "Select formulations and doses" } %>

	<% optionsString = "<option>" "" "</option>"
	durations = ['4 days','1 week','2 weeks','1 month','2 months','3 months','4 months','5 months','6 months','7 months','8 months']
	durations.each do |duration|
	  if duration.match(/week/i)
		days = (((duration.to_i)*7))
	  elsif duration.match(/days/i)
		days = 4
	  elsif duration.match(/month/i)
		days = (((duration.to_i)* 28))
	  end
	  optionsString += "<option value = '" + days.to_s + "'>" + duration + "</option>"
	end
  %>
	<%= select_tag :tb_duration, optionsString,
	  {	:condition => '$("prescribe_tb_drugs").value == "YES"',
	  :tt_onLoad => "__$('keyboard').style.display = 'none'",
	  :helpText => 'Duration' } %>


  <%end%>

  <% if @transfer_out_patient %>
	<%= touch_yes_no_tag "Prescribe drugs", @patient, nil,
	  {	:optional => false,
	  :id => 'prescribe_continuation_tb_drugs',
	  :condition => 'isRegisteredForTB() == true',
	  :helpText => "Prescribe Continuation TB Regimen?" } %>

	<%= select_tag :tb_continuation_regimen_concept_id, nil,
	  {	:ajaxUrl => "",
	  :allowFreeText => 'false',
	  :tt_onLoad => "set_patient_program_for_suggestions($('tb_patient_program').value);setTimeout('setSelectedRow()',500);",
	  :condition => '$("prescribe_continuation_tb_drugs").value == "YES"',
	  :helpText => "Select TB regimen" } %>

	<%= text_field_tag :tb_continuation_regimen, nil,
	  {
	  :ajaxUrl => "",
	  :tt_onUnLoad => "setRegimenId('TB Continuation');" ,
	  :allowFreeText => true ,
	  :tt_onLoad => "set_regimen_concept_id_for_regimen($('tb_patient_program').value, $('tb_continuation_regimen_concept_id').value);buildPrescriptionPage('NO',  $('tb_patient_program').value, $('tb_continuation_regimen_concept_id').value, 'tb_prescription_container');",
	  :condition => '$("prescribe_continuation_tb_drugs").value == "YES"',
	  :helpText => "Select formulations and doses" } %>

	<% optionsString = "<option>" "" "</option>"
	durations = ['4 Days','1 week','2 weeks','1 month','2 months','3 months','4 months','5 months','6 months','7 months', '8 months']
	durations.each do |duration|
	  if duration.match(/week/i)
		days = (((duration.to_i)*7))
	  elsif duration.match(/days/i)
		days = 4
	  elsif duration.match(/month/i)
		days = (((duration.to_i)* 28))
	  end
	  optionsString += "<option value = '" + days.to_s + "'>" + duration + "</option>"
	end
  %>
	<%= select_tag :tb_continuation_duration, optionsString,
	  {	:condition => '$("prescribe_continuation_tb_drugs").value == "YES"',
	  :helpText => 'Duration of TB drugs' } %>

  <% end %>

  <!-- HIV Regimen -->
  <% if @hiv_programs.uniq.count > 1 %>
	<%= select_tag :patient_program, options_for_select(@hiv_programs.map{|program| [program.program.name, program.patient_program_id] if PatientProgram.find(program.patient_program_id).date_completed == nil}), {
	  :textCase => "upper",
	  :allowFreeText => 'false',
	  :helpText => "Prescribe regimen for which ARV program?"}%>
  <%else%>
	<%= hidden_field_tag(:patient_program, (@hiv_programs.first.patient_program_id rescue '')) %>
  <%end%>

  <%= touch_yes_no_tag "PRESCRIBE ARVS", @patient, nil,
	{:id => 'prescribe_arvs',
	:allowFreeText => 'false',
	:condition => 'hasReasonForART() == true && prescribeAntiretroviralDrugs() == true',
	:helpText => "Prescribe ARVs?" } %>

  <%#= select_tag :continue_existing_regimen, options_for_select([['',''],['Yes','YES'],['No','NO']], ''), {
	:textCase => "upper",
	:allowFreeText => 'false',
	:id => "continue_existing_regimen",
	:tt_onLoad => 'showDrugs();setAttributes();changeButton();',
	:validationCode => "continueRegimen() != 'true';",
	:validationMessage => "Patient is starting a new regimen",
	:tt_onUnLoad => 'resetAttributes();',
	:condition => 'existingRegimen();',
	:helpText => "Continue current ARV drugs?"}%>
  <%= touch_hidden_tag "Reason antiretrovirals changed or stopped", @patient, nil, {
	  :id => 'reason_antiretrovirals_changed_or_stopped'} %>

  <%= select_tag :continue_existing_regimen, options_for_select([['',''],['Yes','YES'],['No','NO']], ''), {
	:textCase => "upper",
	:allowFreeText => 'false',
	:id => "continue_existing_regimen",
	:tt_onLoad => 'showDrugs();setAttributes();changeButton();',
	:tt_onUnLoad => 'resetAttributes();resetRegimen();',
	:condition => 'existingRegimen();',
	:helpText => "Continue current ARV drugs?"}%>

  <%= select_tag :regimen_concept_id, nil, {
	:ajaxUrl => "",
	:allowFreeText => 'false',
	:tt_onLoad => "changeRegimen();set_patient_program_for_suggestions($('patient_program').value);setTimeout('setSelectedRow()',500);",
	:condition => 'hasReasonForART() == true && $("prescribe_arvs").value == "YES" && $("continue_existing_regimen").value != "YES"',
	:helpText => "Select ART regimen",
	:tt_onUnload => "resetRegimen()"}%>

  <%= text_field_tag :regimen, nil, {
	:ajaxUrl => "",
	:tt_onUnLoad => "setRegimenId('ART');" ,
	:allowFreeText => true ,
	:tt_onLoad => "set_regimen_concept_id_for_regimen($('patient_program').value, $('regimen_concept_id').value);buildPrescriptionPage($('continue_existing_regimen').value,$('patient_program').value,$('regimen_concept_id').value,'prescription_container');",
	:condition => 'hasReasonForART() == true && $("prescribe_arvs").value == "YES" && $("continue_existing_regimen").value !="YES"',
	:helpText => "Select formulations and doses"}%>

<%#= text_field_tag :duration, nil, {
:ajaxURL => "",
:field_type => 'number',
:units => 'days',
:tt_onLoad => 'set_regimen_concept_id_for_duration();',
:helpText => "Duration (days)",
:validationRule => "([0-9]+\\.?[0-9]*)|Unknown$",
:validationMessage => "You must enter a number (for example: 5<b>.0</b>)",
:allowFreeText => "true",
:tt_pageStyleClass => "NumbersOnlyWithDecimal"}%>



  <%= select_tag :duration, optionsString, {
	:condition => '$("prescribe_arvs").value == "YES" || $("cpt_given").value == "YES" || $("ipt_given").value == "YES"',
	:tt_onLoad => "__$('keyboard').style.display = 'none'",
	:helpText => 'Duration of prescribed drugs' } %>

  <!-- CPT & IPT-->
  <% if @alergic_to_suphur == true %>
	<%= touch_hidden_tag "Prescribe cotramoxazole", @patient, "NO", :id => "cpt_given" %>
  <% else %>
	<%= touch_yes_no_tag "Prescribe cotramoxazole", @patient, nil,
	  {	:id => 'cpt_given',
	  :allowFreeText => 'false',
	  :condition => 'prescribeAntiretroviralDrugs() == true',
	  :helpText => "Prescribe CPT" } %>
  <% end %>

  <% if @patient_bean.age >= 2 && !@current_hiv_program_state.match(/On antiretrovirals/i) && !@current_hiv_program_state.match(/Patient transferred in/i) %>
	<%= touch_yes_no_tag "ISONIAZID", @patient, nil,
	  {	:id => 'ipt_given',
	  :allowFreeText => 'false',
	  :condition => "prescribeAntiretroviralDrugs() && $('prescribe_arvs').value != 'YES'",
	  :helpText => "Prescribe IPT" } %>
  <%else%>
	<%= touch_hidden_tag "ISONIAZID", @patient, "", :id => "ipt_given" %>
  <%end%>

  <% if @patient_bean.age >= 14 %>
	<% if @retrospective %>
	  <%= touch_numeric_tag "CONDOMS", @patient, nil,
		{	:max => '100',
		:condition => 'hasARTVisit() == true;',
		:tt_pageStyleClass => "unknownButton",
		:helpText => 'Number of condoms given'
	  } %>
	<% else %>
	  <%= touch_numeric_tag "CONDOMS", @patient, nil,
		{	:max => '100',
		:condition => 'hasARTVisit() == true;',
		:helpText => 'Number of condoms given'
	  } %>
	<% end %>

  <% end %>

  <%= touch_text_area_tag "CLINICAL NOTES CONSTRUCT", @patient, nil,
	{	:id => "clinical_notes",
	:optional => true,
	:helpText => "Clinical notes (optional)"
  }, time=DateTime.now() %>

  <% initial_date = "#{session[:datetime].strftime('%Y-%m-%d')}" rescue "#{(Date.today).strftime('%Y-%m-%d')}" %>

  <%
  transfer_location_id = nil
  transfer_within_responsibility_value = 'Unknown'
  current_state_value = nil

  program_workflow = ProgramWorkflow.all(:conditions => ['program_id = ?', Program.find_by_name("TB PROGRAM").id], :include => :concept)
  program_workflow_id = program_workflow.first.program_workflow_id

  states = ProgramWorkflowState.all(:conditions => ['program_workflow_id = ?', program_workflow_id], :include => :concept)

  states.each do |state|
	concept = state.concept
	if (concept.fullname == "Patient transferred out")
	  current_state_value = state.program_workflow_state_id
	  break
	end
  end

  if !@tb_encounter.blank?
	for obs in @tb_encounter.observations do
	  if obs.concept_id == ConceptName.find_by_name("Transfer to").concept_id
		transfer_location_id = "#{obs.to_s(["short", "order"]).to_s.split(":")[1].to_i}"
	  elsif obs.concept_id == ConceptName.find_by_name("Transfer within responsibility").concept_id
		transfer_within_responsibility_value = "#{obs.to_s(["short", "order"]).to_s.split(":")[1].to_s}"
	  end
	end
  end

  program = PatientProgram.find(:all,:conditions =>["voided = 0 AND patient_id = ?
	AND program_id = ? AND location_id = ?", @patient.id ,
	  Program.find_by_name("TB PROGRAM").id, Location.current_health_center.id]).last rescue nil


  if program != nil
	if (program.date_completed.blank?)
	  if !transfer_location_id.blank? %>
		<%= hidden_field_tag "transfer_data[]transfer_out_location_id", transfer_location_id %>
		<%= hidden_field_tag "transfer_data[]current_state", "#{current_state_value}" %>
		<%= hidden_field_tag "transfer_data[]current_date", "#{initial_date}" %>

		<%= hidden_field_tag "transfer_data[]patient_program_id", "#{program.id}" %>

		<%= hidden_field_tag "transfer_data[]patient_id", @patient.id %>
		<%= hidden_field_tag "transfer_data[]location", Location.current_health_center.id %>

		<%= hidden_field_tag "transfer_data[]encounter[provider_id]", current_user.user_id %>
		<%= hidden_field_tag "transfer_data[]encounter[encounter_type_name]", "TRANSFER OUT" %>
		<%= hidden_field_tag "transfer_data[]encounter[patient_id]", @patient.id %>
		<%= hidden_field_tag "transfer_data[]encounter[encounter_datetime]", DateTime.now() %>

		<%= hidden_field_tag "transfer_data[]observations[][patient_id]", @patient.id  %>
		<%= hidden_field_tag "transfer_data[]observations[][concept_name]", "TRANSFER WITHIN RESPONSIBILITY" %>
		<%= hidden_field_tag "transfer_data[]observations[][obs_datetime]", DateTime.now() %>
		<%= hidden_field_tag "transfer_data[]observations[][value_coded_or_text]", "#{transfer_within_responsibility_value}"%>
	  <%end
	end
  end%>

  <% if @retrospective %>

	<p><label for="filter_provider">Staff who provided the information (Provider)</label></br>
	<%= text_field "filter" , 'provider', :helpText => 'Staff who provided the information (Provider)', :ajaxURL => '/user/username?username=' %></p>
  <% else %>
	<%= hidden_field_tag "filter[provider]", nil %>
  <%end%>
</form>
  <div id="previous_drugs_dispensed">
  </div>
</body>
