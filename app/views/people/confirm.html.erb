<html>
  <head>
    <title>Patient Treatment Dashboard</title>
    <script type="text/javascript" language="javascript"
    src="/touchscreentoolkit/lib/javascripts/touchScreenToolkit.js" defer  ></script>    
    <meta http-equiv='content-type' content='text/html;charset=UTF-8' />
    <%#= javascript_include_tag "jquery" %>
    <%= javascript_include_tag "Highcharts/js/jquery.min.js" %>
    <%= javascript_include_tag "jquery.flot" %>
    <%= javascript_include_tag "prototype" %>

    <% if Location.current_location.name.match(/HIV|ART/i) %>
      <style>
        #buttonlinks {
          display: none;
        }
        #tab2 {
          background-color: white;
          border: 0 none;
          color: black;
          font-weight: bold;
        }
      </style>
    <% else %>
      <style>
         #buttonlinks {
          display: none;
        }
        #tab1 {
          background-color: white;
          border: 0 none;
          color: black;
          font-weight: bold;
        }

      </style>
    <% end %>
    <style>
      #vl_data{
        position: absolute;
        -moz-user-select: none;
        background-color: #FFFFFF;
        border: 1px solid #999999;
        border-radius: 20px 20px 20px 20px;
        display: table;
        margin: 5px;
        overflow: hidden;
        padding: 10px;
        width: 36%;
        z-index: 800;
        right: 10px;
        top: 0%;
        height: 26%;
        }

      #vl_update {
        position: absolute;
        border-radius: 17px;
        background-color: #CD853F;
        border-bottom: 1px outset black;
        border-style: outset;
        border-top: 5px outset #0000CD;
        color: white;
        padding: 4px 8px 8px 4px;
        text-align: center;
        text-decoration: none;
        cursor: pointer;
        font-weight: bold;
        font-size: 14pt;
        width: 32%;
        left: 0%;
        top: 117%;
        letter-spacing: 7px;
      }
      #view_vl_results{
        position: absolute;
        border-radius: 17px;
        background-color: #CD853F;
        border-bottom: 1px outset black;
        border-style: outset;
        border-top: 5px outset #0000CD;
        color: white;
        padding: 4px 8px 8px 4px;
        text-align: center;
        text-decoration: none;
        cursor: pointer;
        font-weight: bold;
        font-size: 14pt;
        width: 38%;
        right: 6%;
        top: 117%;
        letter-spacing: 7px;
      }
      
      #update_vl_menu{
        border-radius: 10px;
        position: absolute;
        background-color: #DCDCDC;
        border: 3px solid black;
        height: 55%;
        z-index: 991;
        left: 40%;
        top:20%;
        width: 45%;
        left: 20%;
      }
      #update_vl_button{
        display: block;
        border-radius: 17px;
        background-color: #6E7B8B;
        border-style: outset;
        padding: 19px 21px 18px 45px;
        cursor: pointer;
        width: 40%;
        margin-left: 20%;
        text-align: center;
        color: white;
        font-size: 14pt;
      }
      #gray_button{
        background-color: gray;
        border-radius: 10px;
        width: 50%;
      }
      #update_vl_button_gray{
        display: block;
        border-radius: 17px;
        background-color: #C5C1AA;
        border-style: outset;
        padding: 19px 21px 18px 45px;
        cursor: not-allowed;
        width: 40%;
        margin-left: 20%;
        text-align: center;
        color: gray;
        font-size: 14pt;
      }
      .popup_vl{
        border-radius: 10px !important;
        position: absolute;
        background-color: #DCDCDC;
        border: 3px solid black !important;
        height: 45% !important;
        left: 40% !important;
        top:20% !important;
        width: 45% !important;
        left: 20% !important;
      }

      #close{
        height: 18%;
        width: 11%;
        position: absolute;
        left: 87%;
      }
    </style>
    <script>

      jQuery(document).ready(function() {
        loadChart();
        //addDivToContent()
      });

      function addDivToContent(){
        c = document.getElementById('content');
        p = document.getElementById('popup');
        v = document.getElementById('vl_data');
        //c.appendChild(p);
        c.appendChild(v);
      }
      window.setTimeout("addDivToContent();", 250);
      
      var patientDash = "/patients/show/<%= params[:found_person_id] %>"
      tt_cancel_destination = "/clinic";

<%if !@patient_bean.archived_filing_number.blank? && !@pp.match(/patient\sdied/i) %>
    tt_cancel_show = "javascript:confirmAction(0)";
<% elsif @transferred_out  %>
    tt_cancel_show = "javascript:confirmAction(1)";
<% elsif @defaulted  %>
    tt_cancel_show = "javascript:confirmAction(2)";
<% else %> 
    tt_cancel_show = "<%=@task.url%>";

<% end %>

  function changeAttributes(){
    document.getElementById("btnNext").innerHTML = "<span>Continue</span>"

    <% if improved_viral_load_check(@person.patient) == true &&
        (@task.encounter_type.upcase == "HIV CLINIC CONSULTATION" || @task.encounter_type.upcase == "HIV STAGING") &&  show_lab_results &&
        (current_user_roles.include?("Nurse") || current_user_roles.include?("Clinician") || current_user_roles.include?("Doctor"))%>
         document.getElementById("btnNext").setAttribute("onclick","showPopup();")
    <% end %>

  <% if viral_load_check_without_lab_results_modified(@person.patient) == true &&
        (@task.encounter_type.upcase == "HIV CLINIC CONSULTATION" || @task.encounter_type.upcase == "HIV STAGING") &&
        !show_lab_results &&
        (current_user_roles.include?("Nurse") || current_user_roles.include?("Clinician") || current_user_roles.include?("Doctor"))%>
         document.getElementById("btnNext").setAttribute("onclick","showPopup();")
  <% end %>
  }
			
  function showPopup(){
    popup = document.getElementById('popup')
    content = document.getElementById('content')
    content.appendChild(popup)
    if (typeof popup != 'undefined'){
      document.getElementById('popup').style.display='inline'
      document.getElementById('cover').style.display='inline'
    }
  }

  function confirmOperations(message, responseAction, okOnly) {

    if(!__$("tstMessageBar")){
        var tstMessageBar = document.createElement("div");
        tstMessageBar.id = "tstMessageBar";
        tstMessageBar.className = "messageBar";

        __$("content").appendChild(tstMessageBar);

    }

    __$("tstMessageBar").innerHTML = (message ? message : "Some important tasks are yet to be done. " +
        "Are you sure you still want to continue?") + "<br/>" +
    (okOnly ? "" : "<button onmousedown='hideMessage(); cancelOperation(\"" + responseAction + "\");'><span>Yes</span></button>") +
    "<button onmousedown='hideMessage(); cancelOperation(\"" + patientDash + "\");'><span>" + (okOnly ? "OK" : "No") + "</span></button>";
    __$("tstMessageBar").style.display = "block";

}

function cancelOperation(action){
    window.location = action;
}

  function confirmAction(status){
    if(status == 0) {
      confirmOperations("Patient files in archive cabinets.Move to active cabinets?",
      "/patients/set_new_filing_number/<%=@person.patient.id %>");
    } else if(status == 1) {
      confirmOperation("Patient was transferred out. Do you wish to continue?",
      "<%=@task.url%>");
    } else if(status == 2) {
      confirmOperation("Patient is a defaulter. Do you wish to continue?",
      "<%=@task.url%>");
    }
    
    return;
  }

  function reSize(){
    __$("patient-dashboard-main").style.width = "100%";
  }
  function loadChart(){
    
    try{
      <%
      dateToday = session[:datetime].to_date rescue Date.today
      %>
      age = "<%=  @patient_bean.age_in_months rescue 99999%>";
      document.getElementById('tabPageContainer').innerHTML = "<div id='summary' style='background: width:100%;'></div>" ;
      if (age <= 60){
        jQuery('#summary').empty();
        jQuery('#summary').load('/patients/baby_chart/<%= @patient_bean.patient_id %>?patient_id=<%= @patient_bean.patient_id %>&tab=true');
      }else{
        jQuery('#summary').empty();
        jQuery('#summary').load('/people/area_graph_adults?id=<%=@patient_bean.patient_id%>');
      }
    }catch(exp){
      setTimeout("loadChart()", 100);
    }  
  
  } 
  
			
  setTimeout('reSize()',500);

  function updateVl(){
    content = document.getElementById('content');
    vl_menu = document.getElementById('new_vl_menu');
    content.appendChild(vl_menu);
    vl_menu.style.display = 'inline';
    document.getElementById('vl_lab_trail_cover').style.display='inline';
    //document.getElementById('cover').style.display='inline'
  }

  function removeUpdateVlMenu(){
    vl_menu = document.getElementById('new_vl_menu');
    vl_menu.style.display='none';
    cover = document.getElementById('vl_lab_trail_cover');
    cover.style.display='none'
  }

  function newVlResultPath(){
    <%  person_id =  params[:found_person_id] %>
    window.location = "/lab/viral_load_result?patient_id=<%= person_id %>"
  }

  function giveResultPath(){
    <%  person_id =  params[:found_person_id] %>
    window.location = "/lab/give_result?patient_id=<%= person_id %>"
  }

  function secondlineSwitchPath(){
    <%  person_id =  params[:found_person_id] %>
    window.location = "/lab/second_line_switch?patient_id=<%= person_id %>"
  }
    </script>
  </head>
  <body onload = "setTimeout('changeAttributes()',500);">
    <% 	task = @task
    task_name = (task.encounter_type || 'NONE').upcase rescue 'NONE' %>

    <form id = 'dashboard' action='/clinic'>
      <!--
      <div id='project_name'>
        <%#=what_app?%>
      </div>-->
      
      <span id='patient_name'><%= @patient_bean.name rescue "" %></span>
      <span id='patient_id'><%= @patient_bean.national_id_with_dashes rescue "" %></span>
      <span id='patient_residence'><%= @patient_bean.current_residence rescue "" %></span>

      <% if @patient_bean.age > 0 %>
        <span id='patient_age'><%= @patient_bean.age rescue "" %></span>
      <% else %>
        <span id='patient_age'><%= "#{@patient_bean.age_in_months} Months" rescue "" %></span>
      <% end %>

      <span id='patient_guardian'><%= @patient_bean.guardian rescue "" %></span>
      <span id='patient_gender'><%= @patient_bean.sex rescue "" %></span>

      <div id="patient_card">
        <% if Location.current_location.name.match(/HIV|ART/i) %>
          <%if(@patient_bean.guardian != nil) %>
            <span value="<%= @patient_bean.guardian rescue '' %>">Guardian</span>
          <% end %>

          <% if (@reason_for_art_eligibility rescue nil) != nil && (@reason_for_art_eligibility) != "" %>
            <span value="<%= @reason_for_art_eligibility rescue "" %>">Reason for Starting</span>
          <% end %>

          <% if (@arv_number rescue nil) != nil && (@arv_number) != " " %>
            <span value="<%= @arv_number rescue '' %>">ARV Number</span>
          <% end %>

          <% if (@tb_number rescue nil) != nil && (@tb_number) != " " %>
            <span value="<%= @tb_number rescue '' %>">TB Number</span>
          <% end %>

          <% if (@patient_bean.eid_number rescue nil) != nil && (@patient_bean.eid_number) != " " %>
            <span value="<%= @patient_bean.eid_number rescue "" %>">EID Number</span>
          <% end %>

          <% if (@patient_bean.pre_art_number rescue nil) != nil && (@patient_bean.pre_art_number) != " " %>
            <span value="<%= @patient_bean.pre_art_number rescue "" %>">Pre-ART Number</span>
          <% end %>
          <% unless @art_start_date.blank? %>
            <span value="<%= @art_start_date.strftime("%d-%b-%Y") rescue "" %>">ART start date</span>
            <span value="<%= @duration_in_months.to_s + ' Months'  rescue "" %>">Duration on ART</span>
          <% end %>
          <% unless @second_line_treatment_start_date.blank? %>
            <span value="<%= @second_line_treatment_start_date.strftime("%d-%b-%Y") rescue "" %>">ART start date(2<sup>nd</sup> Line)</span>
            <span value="<%= @second_line_duration_in_months.to_s + ' Months'  rescue "" %>">Duration on 2<sup>nd</sup> Line ART</span>
          <% end %>
          <% unless @results.blank? %>
            <span value="<%= @modifier + ' ' + @latest_result.to_s + ' (' + @latest_date.strftime("%d-%b-%Y").to_s + ')' %>">Latest Viral load</span>
          <% end %>
        <% end %>
          <% if (@patient_bean.filing_number rescue nil) != nil && (@patient_bean.filing_number) != " " %>
            <span value="<%= @patient_bean.filing_number rescue "" %>">Filing Number</span>
          <% end %>

          <% if (@patient_bean.archived_filing_number rescue nil) != nil && (@patient_bean.archived_filing_number) != " " %>
            <span value="<%= @patient_bean.archived_filing_number rescue "" %>">Archived Filing Number</span>
          <% end %>

      </div>

      <select id="tabs">
        <% if Location.current_location.name.match(/HIV|ART/i) %>
          <option value='/patients/overview?patient_id=<%= @person.patient.id %>'>Overview</option>
        <% end %>
        <option value='/patients/next_task_description?task_id=<%= task.id -%>'>
					NEXT TASK: <%= task_name.gsub('_',' ') %>
        </option>
      </select>

      <input type='submit' value='Finish' />
    </form>

    <% if improved_viral_load_check(@person.patient) == true &&
        (@task.encounter_type.upcase == "HIV CLINIC CONSULTATION" || @task.encounter_type.upcase == "HIV STAGING") &&
        show_lab_results &&
        (current_user_roles.include?("Nurse") || current_user_roles.include?("Clinician") || current_user_roles.include?("Doctor"))%>

      <div id="popup" style="display:none">

        <div class="art_container">
          <div class="header" style="position: absolute; left: 150px">
            <div id="viral_header">
              <u>Routine Viral Load Screening Due</u><br />
              <u>Assess Adherence:</u> <br />
            </div>
            <div id="more_details" style="font-size: 16pt; font-weight:bold; ">
              If good then request VL today <br />
              If poor then defer VL for three months after intensive adherence support
            </div>
          </div>
          <table  border=0.5 style = "border-radius:10px;">
            <tr>
              <td><span>ART start date</span></td>
              <td style='text-align:left'><span><%= @art_start_date.strftime("%A, %d %B %Y") rescue '' %></span></td>
            </tr>
            <tr><td colspan =2><hr/></td></tr>
            <tr>
              <td><span>Duration on ART (Months)</span></td>
              <td style='text-align:left'><span><%= @duration_in_months %></span></td>
            </tr>
            <tr><td colspan =2><hr/></td></tr>

            <% unless @second_line_treatment_start_date.blank? %>
              <tr>
                <td><span>Duration on 2<sup>nd</sup>Line ART (Months)</span></td>
                <td style='text-align:left'><span><%= @second_line_duration_in_months %></span></td>
              </tr>
              <tr><td colspan =2><hr/></td></tr>
            <% end  %>

            <% unless @results.blank?%>
              <tr>
                <td><span>Latest viral load (<%= @latest_date.strftime("%A, %d %B %Y")%>)</span></td>
                <td style='text-align:left'><span><%= @modifier + ' ' + @latest_result.to_s %></span></td>
              </tr>
              <tr><td colspan =2><hr/></td></tr>
            <% end %>

            <tr>
              <td><span>Outcome</span></td>
              <td style='text-align:left'><span><%= @outcome %></span></td>
            </tr>
            <tr><td colspan =2><hr/></td></tr>
            <tr>
              <td><span>Reason for starting</span></td>
              <td style='text-align:left'><span><%=@reason_for_art%></span></td>
            </tr>

          </table>
        </div>

        <hr class="popup_hr"></hr>
        <a id='viral_load_done' onclick = "viral_load_requested_today();" ><span>VL Requested Today</span></a>
                    <!--<a id='lab_trail' onclick="window.location='/lab/results/<%=@person.id%>'"><span>View Lab Trail</span></a>-->
        <a id='reminder' onclick="removePopup();"><span>VL Not Requested Today</span></a>
      </div>

      <div id="cover">
      </div>
    <% end %>
    <script>
      function removePopup(){
        popup = document.getElementById('popup')
        popup.parentNode.removeChild(popup)
        cover = document.getElementById('cover')
        if (cover){
          cover.parentNode.removeChild(cover)
        }
        <%if !@patient_bean.archived_filing_number.blank? %>
              javascript:confirmAction(0);
        <% elsif @transferred_out  %>
              javascript:confirmAction(1);
        <% elsif @defaulted  %>
              javascript:confirmAction(2);
        <% else %>
              window.location="<%= next_task(@person.patient)%>"
        <% end %>	
  }
			
  function viral_load_requested_today(){
			
    jQuery.ajax({
      type: "POST",
      url: "/patients/viral_load_request",
      data: "patient_id="+<%=@person.patient.id %> + "&requested_today=true",
      success: function(){
        window.location="<%= next_task(@person.patient)%>"
      }
					
    });
  }

  function viral_load_not_requested_today(){

    jQuery.ajax({
      type: "POST",
      url: "/patients/viral_load_request",
      data: "patient_id="+<%=@person.patient.id %>,
      success: function(){
        window.location="<%= next_task(@person.patient)%>"
      }

    });
  }

  function vl_requested_today(){

  }

  function vl_already_done(){
    jQuery.ajax({
      type: "POST",
      url: "/patients/viral_load_already_done",
      data: "patient_id="+<%=@person.patient.id %>,
      success: function(){
        window.location="<%= next_task(@person.patient)%>"
      }

    });
  }

  function vl_adherence_issue(){
    jQuery.ajax({
      type: "POST",
      url: "/patients/vl_not_done_due_to_adherence",
      data: "patient_id="+<%=@person.patient.id %>,
      success: function(){
        window.location="<%= next_task(@person.patient)%>"
      }

    });
  }

  function hidePopup(){
    //document.getElementById('popup').style.display = 'none'
    window.location="<%= next_task(@person.patient)%>"
  }

  function captureVl(){
    window.location="/lab/new?patient_id=<%= @person.patient.id %>&viral_load=true"
  }

  function showVlLabTrail(){
    c = document.getElementById('content');
    v = document.getElementById('vl_lab_trail');
    c.appendChild(v);
    document.getElementById('vl_lab_trail_cover').style.display='inline';
    document.getElementById('vl_lab_trail').style.display='inline';
  }

  function hideVlLabTrail(){
    document.getElementById('vl_lab_trail_cover').style.display='none';
    document.getElementById('vl_lab_trail').style.display='none';
  }
</script>
  <style>
    .art_container table{
      background-color:gold;
      color: black;
      font-size: 18pt;
      font-weight: bold;
      left: 7px;
      line-height: 35px;
      position: absolute;
      top: 152px;
      width: 99%;
      border: 1px solid black;
    }
    #popup{
      -moz-user-select: none;
      background-color: white;
      border: 4px solid #C6C6C6;
      border-radius: 15px 15px 15px 15px;
      color: black;
      font-size: 28px;
      height: 579px;
      left: 2%;
      padding: 5px;
      position: absolute;
      text-align: center;
      top: 5%;
      width: 94%;
      z-index: 991;
    }
    #cover{
      display:none;
      position: absolute;
      background-color: black;
      width: 100%;
      height: 102%;
      left: 0%;
      top: 0%;
      z-index: 990;
      opacity: 0.5;
    }

    #viral_load_done {
      position: absolute;
      border-radius: 7px;
      background-color:	#2E8B57;
      border-bottom: 1px outset black;
      border-style: outset;
      border-top: 1px outset black;
      color: white;
      padding: 9px 16px 16px 19px;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      bottom: 0px;
      left: 54px;
      font-weight: bold;
      font-size: 18pt;
    }

    #lab_trail {
      position: absolute;
      border-radius: 7px;
      background-color: #2E8B57;
      border-bottom: 1px outset black;
      border-style: outset;
      border-top: 1px outset black;
      color: white;
      padding: 9px 16px 16px 19px;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      bottom: 0px;
      left: 372px;
      font-weight: bold;
      font-size: 18pt;
    }


    #reminder {
      position: absolute;
      border-radius: 7px;
      background-color: #2E8B57;
      border-bottom: 1px outset black;
      border-style: outset;
      border-top: 1px outset black;
      color: white;
      padding: 9px 16px 16px 19px;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      bottom: 0px;
      left: 572px;
      font-weight: bold;
      font-size: 18pt;
    }

    .popup_hr{
      position: absolute;
      background-color: #669999;
      height: 5px;
      width: 99%;
      bottom: 55px;

    }

    .popup_hr_without_lab{
      position: absolute;
      background-color: #669999;
      height: 5px;
      width: 99%;
      bottom: 68px;

    }

    #viral_header{
      font-family: "Century Gothic", CenturyGothic, AppleGothic, sans-serif;
      font-weight: bold;
      font-size: 18pt;
      color: #1874CD;
    }

    #more_details{
      font-family: Georgia, Times, "Times New Roman", serif;

    }

    #viral_load_requested_today {
      position: absolute;
      border-radius: 7px;
      background-color:	#2E8B57;
      border-bottom: 1px outset black;
      border-style: outset;
      border-top: 1px outset black;
      color: white;
      padding: 9px 16px 16px 19px;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      bottom: 0px;
      left: 4%;
      font-weight: bold;
      font-size: 14pt;
    }

    #viral_load_already_done {
      position: absolute;
      border-radius: 7px;
      background-color:	#2E8B57;
      border-bottom: 1px outset black;
      border-style: outset;
      border-top: 1px outset black;
      color: white;
      padding: 9px 16px 16px 19px;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      bottom: 0px;
      right: 4%;
      font-weight: bold;
      font-size: 14pt;
    }

    #viral_load_adherence_issues {
      position: absolute;
      border-radius: 7px;
      background-color:	#2E8B57;
      border-bottom: 1px outset black;
      border-style: outset;
      border-top: 1px outset black;
      color: white;
      padding: 9px 16px 16px 19px;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      bottom: 0px;
      left: 644px;
      font-weight: bold;
      font-size: 14pt;
    }

    #vl_lab_trail, #new_vl_menu{
      position: absolute;
      width: 95%;
      height: 70%;
      top: 10%;
      z-index: 991;
      left: 3%;
      border: 1px solid black;
      background-color: #FEE0C6;
      border-radius: 15px;
    }
    #vl_lab_trail_header, #new_vl_menu_header{
      padding: 10px;
      background-color: gray;
      color: white;
      border-radius: 15px 15px 0px 0px;
      
    }
     #vl_lab_trail_footer, #new_vl_menu_footer{
      background-color: gray;
      height: 60px;
      width: 100%;
      position: absolute;
      width: 100%;
      position: absolute;
      bottom: 0px;
      border-radius: 0px 0px 15px 15px;
     }
     #vl_lab_trail_footer span{
        border-radius: 13px;
        background-color: #C1CDCD;
        position: absolute;
        padding: 12px 20%;
        left: 27%;
        bottom: 8px;
        cursor: pointer;
     }
     #new_vl_menu_footer span{
       border-radius: 8px;
        background-color: #C1CDCD;
        padding-top: 14px;
        padding-bottom: 14px;
        position: absolute;
        width: 98%;
        left: 1%;
        bottom: 5px;
        cursor: pointer;
     }
     .vl_tbody td{
        border-bottom: 1px solid black;
        border-right: 1px solid black;
      }
      .vl_table_header td{
        border-bottom: 1px solid black;
        border-top: 1px solid black;
      }

      #vl_lab_trail_cover{
        position: absolute;
        background-color: black;
        width: 100%;
        height: 102%;
        left: 0%;
        top: 0%;
        z-index: 990;
        opacity: 0.25;
      }
      #new_vl_menu_content table td{
        border-bottom: 1px solid black;
      }
      #new_vl_menu_content span{
        font-size: 14pt;
        margin-left: 32% !important;
      }
      #new_vl_menu_content tr:hover{
        background-color: white;
      }
      #new_vl_menu_content tr{
        cursor: pointer;
      }
      #vl_data_footer{
        background-color: #FEFEF2;
        height: 60px;
        width: 100%;
        position: absolute;
        width: 99.5%;
        position: absolute;
        bottom: 2px;
        border-radius: 0px 0px 15px 15px;
        left: 1px;
        border-top: 2px solid black;
     }

     #update_span{
       position: absolute;
       padding: 2% 13.5%;
       background-color: #5F9EA0;
       color: white !important;
       left: 1.4%;
       bottom: 8.5px;
       font-size: 14pt;
       border-radius: 10px;
       cursor: pointer;
      }

      #lab_trail_span{
       position: absolute;
       padding: 2% 11.5%;
       background-color: #5F9EA0;
       color: white !important;
       right: 1%;
       bottom: 8.5px;
       font-size: 14pt;
       border-radius: 10px;
       cursor: pointer;
      }
  </style>


<% if viral_load_check_without_lab_results_modified(@person.patient) == true &&
        (@task.encounter_type.upcase == "HIV CLINIC CONSULTATION" || @task.encounter_type.upcase == "HIV STAGING") &&
        !show_lab_results &&
        (current_user_roles.include?("Nurse") || current_user_roles.include?("Clinician") || current_user_roles.include?("Doctor"))%>

  <!-------------------------------------------->
   <% if @vl_request == "YES" %>
      <div id="popup" class="popup_vl" style="display:none; background-color: #DCDCDC;">
        <span style="color: green"><u>Routine Viral Load Screening</u></span><br />
        <span style="color: red">VL Results Available?</span>
        <div style="margin-top:8%;">
          <%  if @enter_lab_results %>
          <span id="update_vl_button" onclick="newVlResultPath();">Enter Viral load result</span><br />
          <%  else %>
          <span id="update_vl_button_gray" onclick="">Enter Viral load result</span><br />
          <% end %>
         <span id="update_vl_button" onclick="hidePopup();">No viral load result available</span><br />
        </div>
          <!--<hr class="popup_hr_without_lab"></hr>-->
            <!--<a id='viral_load_requested_today' onclick = "captureVl()" style="background-color: #6E7B8B"><span>Enter Viral load result</span></a>
            <a id='viral_load_already_done' onclick="hidePopup()" style="background-color: #6E7B8B"><span>No viral load result available</span></a>-->
            <!--
            <a id='viral_load_adherence_issues' onclick="vl_adherence_issue();"><span>Not Requested Today<br />(Due to poor adherence to ART)</span></a>
            -->
          </div>
      <!-------------------------------------------->
   <% else %>
      <div id="popup" style="display:none; background-color: #DCDCDC;">

            <div class="art_container">
              <div class="header" style="position: absolute; left: 20%">
                <div id="viral_header">
                  <u>Routine Viral Load Screening Due</u><br />
                  <u>Assess Adherence:</u> <br />
                </div>
                <div id="more_details" style="font-size: 16pt; font-weight:bold; ">
                  If good then request VL today <br />
                  If poor then defer VL for three months after intensive adherence support
                </div>
              </div>
              <table  border=0.5 style = "border-radius:10px;">
                <tr>
                  <td><span>ART start date</span></td>
                  <td style='text-align:left'><span><%= @art_start_date.strftime("%A, %d %B %Y") rescue '' %></span></td>
                </tr>
                <tr><td colspan =2><hr/></td></tr>
                <tr>
                  <td><span>Duration on ART (Months)</span></td>
                  <td style='text-align:left'><span><%= @duration_in_months %></span></td>
                </tr>
                <tr><td colspan =2><hr/></td></tr>

                <% unless @second_line_treatment_start_date.blank? %>
                  <tr>
                    <td><span>Duration on 2<sup>nd</sup>Line ART (Months)</span></td>
                    <td style='text-align:left'><span><%= @second_line_duration_in_months %></span></td>
                  </tr>
                  <tr><td colspan =2><hr/></td></tr>
                <% end  %>

                <% unless @results.blank?%>
                  <tr>
                    <td><span>Latest viral load (<%= @latest_date.strftime("%A, %d %B %Y")%>)</span></td>
                    <td style='text-align:left'><span><%= @modifier + ' ' + @latest_result.to_s %></span></td>
                  </tr>
                  <tr><td colspan =2><hr/></td></tr>
                <% end %>

                <tr>
                  <td><span>Outcome</span></td>
                  <td style='text-align:left'><span><%= @outcome %></span></td>
                </tr>
                <tr><td colspan =2><hr/></td></tr>
                <tr>
                  <td><span>Reason for starting</span></td>
                  <td style='text-align:left'><span><%=@reason_for_art%></span></td>
                </tr>

              </table>
            </div>

            <hr class="popup_hr_without_lab"></hr>
            <a id='viral_load_requested_today' onclick = "viral_load_requested_today();" ><span>VL Requested Today</span></a>
            <a id='viral_load_already_done' onclick="viral_load_not_requested_today();"><span>VL Not Requested Today</span></a>
            <!--
            <a id='viral_load_adherence_issues' onclick="vl_adherence_issue();"><span>Not Requested Today<br />(Due to poor adherence to ART)</span></a>
            -->
          </div>


      <div id="cover">
      </div>
  <% end %>
<% end %>
<div id="vl_data">

  <% unless @latest_result.blank?%>
      <% if @latest_result.to_i >= 1000 %>
          <span style="letter-spacing: 11px;font-weight:bold; font-family: Nimbus Sans L; margin-left: 20%; color: red; font-size: 14px"><blink>HIGH VIRAL LOAD</blink></span>
      <% else %>
          <span style="font-weight:bold; font-family: Nimbus Sans L; margin-left: 35%;">VIRAL LOAD</span>
      <% end %>
  <% else %>
    <span style="font-weight:bold; font-family: Nimbus Sans L; margin-left: 35%;">VIRAL LOAD</span>
  <% end %>

  <hr style="margin-left:-2%; width:104%;"></hr>
        <div id="vl_details">
          <table style="position:absolute; left:14%; width: 80%;">
            <tr>
              <td style="font-weight: bold; font-size: 1em; padding: 2px; ">Last Viral load </td>
              <% unless @latest_result.blank?%>
                  <% if @latest_result.to_i >= 1000 %>
                    <td style="color:red; font-weight: bold; font-size: 14px"><%= (@modifier + ' ' + @latest_result.to_s) rescue nil %></td>
                  <% else %>
                    <td style=""><%= (@modifier + ' ' + @latest_result.to_s) rescue nil %></td>
                  <% end %>
              <% else %>
                  <% if @vl_request == "YES" %>
                    <td><span style="margin-left: 8%; font-weight: bold; color: red">(Requested)</span></td>
                  <%  else %>
                      <td><span style="margin-left: 4%; font-weight: bold; color: red">(Not requested)</span></td>
                  <% end %>
              <% end %>
            </tr>
            <tr>
              <td style="font-weight: bold; font-size: 1em; padding: 2px; ">Date of Sample</td>
              <% unless  @latest_date.blank?%>
              <td style=""><%= @latest_date.strftime("%d-%b-%Y") rescue nil %></td>
              <% else %>
                <td id="" style="">----------------------------</td>
              <% end %>
            </tr>
            <tr>
                <td style="font-weight: bold; font-size: 1em; padding: 2px; max-width: 61%;">Date given to patient</td>
                <% if vl_available_and_result_given(Patient.find(params[:found_person_id])) == true %>
                    <td style=""><%= @date_vl_result_given.strftime("%d-%b-%Y") %></td>
                <% else %>
                    <td id="" style="">----------------------------</td>
                <% end %>
            </tr>

          </table>
        </div>
        <div id="vl_data_footer">
          <span onclick="updateVl();" id="update_span" style="color: white;">Update</span>
          <span onclick="showVlLabTrail();" id="lab_trail_span" style="color: white;">VL Trail</span>
        </div>
 </div>
      <div id="cover">
      </div>
      <div id="update_vl_menu" style="display:none">
        <div><br />
          <% unless @latest_result.blank?%>
          <span id="update_vl_button" onclick="giveResultPath();">Result given to patient</span><br />
          <% else %>
          <span id="update_vl_button_gray" onclick="">Result given to patient</span><br />
          <%  end %>
          <%  if @enter_lab_results %>
          <span id="update_vl_button" onclick="newVlResultPath();">Enter new VL result</span><br />
          <% else %>
          <span id="update_vl_button_gray" onclick=";">Enter new VL result</span><br />
          <% end %>
          <span id="update_vl_button" onclick="secondlineSwitchPath();">Patient switched to second line</span><br />
          <span id="update_vl_button" onClick="removeUpdateVlMenu();">Back to milestone screening</span>
        </div>
      </div>

      <div id="vl_lab_trail_cover" style="display:none;">

      </div>
      
      <div id="vl_lab_trail" style="display:none;">
        <div id="vl_lab_trail_header">
          <span style="font-size: 16pt; margin-left: 4.5%;">Viral load lab trail</span>
        </div>

        <div id="vl_lab_trail_content">
          <div style="position: relative; overflow:auto; height: 80%;">
          <table cellspacing='0' style="position:absolute; width:94%; top:10%; left: 3%;">
            <tr class="vl_table_header" style="background-color: #A2CD5A; line-height: 2em; font-size: 18px;">
              <td style="min-width: 130px;"><span><center>Date of Sample</center></span></td>
              <td style="min-width: 120px;"><span><center>Result</center></span></td>
              <td><span><center>Result given?</center></span></td>
              <td><span><center>Date result given</center></span></td>
              <td><span><center>Switched to second line?</center></span></td>
            </tr>
          <% @vl_result_hash.each do |sample_id, result| %>
            <tr style="line-height: 3em;" class="vl_tbody">
              <td style="border-left: 1px solid black;">
                  <span><center>  <%= result["date_of_sample"].strftime("%d-%b-%Y") %></center></span>
              </td>
              <td><span><center><%= result["result"] %></center></span></td>
              <td><span><center><%= result["result_given"].capitalize %></center></span></td>
              <td><span><center><%= result["date_result_given"].strftime("%d-%b-%Y") rescue "------" %></center></span></td>
              <td><span><center><%= result["second_line_switch"].capitalize %></center></span></td>
            </tr>
          <% end %>
          </table>
          </div>
        </div>
        
        <div id="vl_lab_trail_footer">
          <span onclick="hideVlLabTrail();">Done</span>
        </div>
      </div>



      <div id="new_vl_menu" style="display: none; width:40%; height: 56%; left:30%;">
          <div id="new_vl_menu_header">
            <span style="font-size: 15pt;">Select action</span>
          </div>
          <div id="new_vl_menu_content">
            <table cellspacing="0" style="position:absolute; width: 100%; height:75%;">
              <% unless @latest_result.blank?%>
                <tr onclick="giveResultPath();" style="line-height: 3em;"><td><span>Result given to patient</span></td></tr>
              <% else %>
                <tr onclick="" style="line-height: 3em; background-color: #FEE0C6;"><td><span style="color:gray;">Result given to patient</span></td></tr>
              <% end %>
              <tr onclick="newVlResultPath();" style="line-height: 3em;"><td><span>Enter new VL result</span></td></tr>
              <tr onclick="secondlineSwitchPath();" style="line-height: 3em;"><td><span>Patient switched to second line</span></td></tr>
              <tr onclick="removeUpdateVlMenu();" style="line-height: 3em;"><td><span>Back to milestone screening</span></td></tr>
            </table>
          </div>
          <div id="new_vl_menu_footer">
            <span onclick="removeUpdateVlMenu();"><b style="margin-left: 45%;">Cancel</b></span>
          </div>
      </div>
</body>
</html>
